{% extends "admin/request_manager/layouts/base.html" %}
{% import 'macros/form_macros.html' as f %}

{% macro request_card(request_num, request_status, requested_date, start_time, end_time, member_name, volunteer_name,
request_type, service, created_date, modified_date, service_category, member_number, is_volunteer ) %}
<div class="ui one cards request-card" style="margin-top:20px">
  <div class="ui card">
    <div class="content" style="background-color: burlywood;">
      <div class="header">
        Request #{{request_num}}
        <div class="ui right floated request-status-value">
          {% if request_status == "Requested" %}
          <div class="ui yellow label">{{request_status}}</div>
          {% elif request_status == "Confirmed" %}
          <div class="ui green label">{{request_status}}</div>
          {% else %}
          <div class="ui red label">{{request_status}}</div>
          {% endif %}
        </div>
      </div>

    </div>
    <div class="content">
      <div class="ui grid">
        <div class="four wide column">
          <div class="ui card">
            <div class="content">
              <div class="header">Saturday</div>
            </div>
            <div class="content">
              <h2><span class="requested-date-value">{% if requested_date %}
                  {{requested_date}}
                  {% else %}
                  N/A
                  {% endif %}</span></h2>
            </div>
            <div class="extra content">
              <h3>{{start_time}} - {{end_time}}</h3>
            </div>
          </div>
        </div>
        <div class="six wide column">
          <h2><span class="requesting-member-value" data-value="{{member_number}}">{{member_name}}</span></h2>
          <h3><em>Volunteer:</em>
            <span class="volunteer-value" data-value="{{volunteer_id}}">{{volunteer_name}}</span>
          </h3>
          <div class="ui label request-type-value" style="margin-bottom: 5px">{{request_type}}</div>

          <div class="ui label">
            <span class="service-category-value">{{service_category}}</span>:
            <div class="detail">{{service}}</div>
          </div>
        </div>
        <div class="six wide column">
          <div>
            <b style="font-size:1.3em">Created Date:</b>
            <p>{{created_date}}</p>
          </div>
          <div style="margin-top: 10px">
            <b style="font-size:1.3em">Modified Date:</b>
            <p>{{modified_date}}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{% macro filter_select_field(field, show_label) %}
<div class="field {% if not show_label %} no label {% endif %}" id="{{field.name}}">
  {{field.label}}
  <div class="ui multiple selection dropdown fluid">
    <i class="dropdown icon"></i>
    <div class="default text">All</div>
    <div class="menu">
      {% for choice in field.choices %}
      <div class="item" data-value="{{choice[0]}}">{{choice[1]}}</div>
      {% endfor %}
    </div>
  </div>
</div>
{% endmacro %}

{% block request_content %}


<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/search_request.css') }}">

<div class="content-section">
  <h2 class="header">Search Criteria</h2>

  {% set flashes = {
  'error': get_flashed_messages(category_filter=['form-error']),
  'warning': get_flashed_messages(category_filter=['form-check-email']),
  'info': get_flashed_messages(category_filter=['form-info']),
  'success': get_flashed_messages(category_filter=['form-success'])
  } %}
  {{ f.begin_form(form, flashes) }}

  <div class="ui three column stackable grid">
    <div class="five wide column">
      {{filter_select_field(form.request_type, false)}}
    </div>
    <div class="five wide column">
      {{filter_select_field(form.service_category, false)}}
    </div>
    <div class="five wide column">
      {{filter_select_field(form.request_status, false)}}
    </div>
  </div>

  <div class="ui two column stackable grid">
    <div class="eight wide column">
      <div class="field">
        {{filter_select_field(form.requesting_member, true)}}
        <label>Service Provider(s)</label>
        <div class="ui menu">
          <div id="select-role" class="ui dropdown item">
            <div class="text">
              All roles
            </div>
            <i class="dropdown icon"></i>
            <div class="menu">
              <div class="item" data-value="">All roles</div>
              <div class="item" data-value="volunteer">Volunteers</div>
              <div class="item" data-value="local-resource">Local Resources</div>
            </div>
          </div>
          <div class="ui fluid multiple search selection dropdown">
            <i class="dropdown icon"></i>
            <div class="default text">All</div>
            <div class="menu" id="service-provider-menu">
              {% for service_provider_info in service_providers %}
              <div class="item" data-role="{{service_provider_info[0]}}" data-id="{{service_provider_info[1]}}">
                {{service_provider_info[2]}}
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="eight wide column">
      <div class="inline fields" id="date-options">
        <label for="date-options">Show:</label>
        <div class="field">
          <div class="ui radio checkbox">
            <input type="radio" name="date-options" checked="" tabindex="0" class="hidden" value="undated">
            <label>Undated</label>
          </div>
        </div>
        <div class="field">
          <div class="ui radio checkbox">
            <input type="radio" name="date-options" tabindex="0" class="hidden" value="dated">
            <label>Dated</label>
          </div>
        </div>
        <div class="field">
          <div class="ui radio checkbox">
            <input type="radio" name="date-options" tabindex="0" class="hidden" value="both">
            <label>Both</label>
          </div>
        </div>
      </div>

      <div class="inline fields">
        <div class="ui icon button" id="leftbutton">
          <i class="caret left icon"></i>
        </div>
        <select class="ui dropdown" id="timePeriod" name="timePeriod">
          <option value="">Nothing Selected</option>
          {% for choice in form.time_period.choices %}
          <option value={{ choice[0] }}>{{choice[1]}}</option>
          {% endfor %}
        </select>
        <div class="ui icon button" id="rightbutton">
          <i class="caret right icon"></i>
        </div>
      </div>
      <div class="fields">

        <div class="field">
          <label>{{ form.start_date.label }}:</label>
          <input type="date" id="startdate" name="trip-start" class="setDate" value="">
        </div>
        <div class="field">
          <label>{{form.end_date.label}}:</label>
          <input type="date" id="enddate" name="trip-start" value="">
        </div>

      </div>
    </div>

  </div>
  <div class="ui one column centered grid">
    <div class="ui button" type="submit" id="filter-button">Apply Filters</div>
  </div>
  {{f.end_form()}}

  <script type="text/javascript">
    $(document).ready(function () {
      // this applies the search to the entire text (not just the beginning)
      $('.ui.dropdown').dropdown({ fullTextSearch: true });
    });
  </script>

</div>

<h2 class="header" class="divleft">Search Results</h2>
<div id="" class="divright">(3 Results Found)</div>

<hr />
<div id="request-search-results">
  {{request_card(6724, "Requested", "06/17", "12:00 PM", "12:00 PM", "Anne Rodda", "Fran Spadafora Manzella",
  "Member's Home", "Pet Care -Vol", "06/15/2021", "N/A", "Volunteer In-Home Support", -2 )}}

  {{request_card(6697, "Confirmed", "06/21", "11:30 AM", "12:40 PM", "Randy Warden", "Hank Dullea",
  "Transportation", "Vol Driver Local Medical Appt", "06/11/2021", "06/18/2021", "Transportation", -1 )}}

  {{request_card(6725, "Canceled", "", "12:00 PM", "12:00 PM", "Anne Rodda", "Hank Dullea",
  "Member's Home", "Pet Care -Vol", "06/15/2021", "N/A", "Volunteer In-Home Support", -2 )}}
</div>
<script text="text/javascript">
  $(document).ready(function () {
    $('.ui.checkbox').checkbox();
    $('#select-role').dropdown({
      onChange: function (value, text, $selectedItem) {
        $('#service-provider-menu').find('.item').each(
          function () {
            $this = $(this);
            let role = $this.attr('data-role');
            $this.show();
            if (value && value != role) {
              $this.hide();
            }
          });

      }
    });

    $('.no.label .ui.multiple.selection.dropdown')
      .dropdown({
        useLabels: false
      });


    $('#filter-button').click(function (e) {
      request_type_filter = [];
      service_category_filter = [];
      request_status_filter = [];
      requesting_member_filter = [];
      volunteer_filter = [];

      // grab filters from relevant form fields
      $('#request_type .menu .item.active').each(function () {
        selected_value = $(this).attr('data-value');
        request_type_filter.push(selected_value);
      });
      $('#service_category .menu .item.active').each(function () {
        selected_value = $(this).attr('data-value');
        service_category_filter.push(selected_value);
      });
      $('#request_status .menu .item.active').each(function () {
        selected_value = $(this).attr('data-value');
        request_status_filter.push(selected_value);
      });
      $('#requesting_member .menu .item.active').each(function () {
        selected_value = $(this).attr('data-value');
        requesting_member_filter.push(selected_value);
      });

      let date_option_filter = $('#date-options').find('[name="date-options"]:checked').val();
      let start_date = $('#startdate').val();
      let end_date = $('#enddate').val()

      window.alert(Date.parse(start_date));
      window.alert(Date.parse("2021-06-29"));

      $('.request-card').each(function () {
        $this = $(this);
        $this.show();
        let request_type = $this.find('.request-type-value').html();
        if (request_type_filter.length > 0 && !request_type_filter.includes(request_type)) {
          $this.hide();
        }
        let service_category = $this.find('.service-category-value').html();
        if (service_category_filter.length > 0 && !service_category_filter.includes(service_category)) {
          $this.hide();
        }
        let request_status = $this.find('.request-status-value').find('div').html();
        if (request_status_filter.length > 0 && !request_status_filter.includes(request_status)) {
          $this.hide();
        }
        let requesting_member = $this.find('.requesting-member-value').attr('data-value');
        if (requesting_member_filter.length > 0 && !requesting_member_filter.includes(requesting_member)) {
          $this.hide();
        }
      });
      return false;
    })

    document.getElementById("leftbutton").onclick = function () {

      var option = document.getElementById("timePeriod").value;
      var start_date = document.getElementById("startdate").value;
      var end_date = document.getElementById("enddate").value;
      var date_values = start_date.split("-");
      var year = parseInt(date_values[0]);
      var month = parseInt(date_values[1]) - 1;
      var date = parseInt(date_values[2]);
      var current = new Date(year, month, date);

      switch (option) {
        case '0':
          var yesterday = new Date(current);
          yesterday.setDate(yesterday.getDate() - 1)
          var new_date = yesterday.getFullYear() + '-' + ("0" + (yesterday.getMonth() + 1)).slice(-2) + '-' + ("0" + yesterday.getDate()).slice(-2);
          var end_date = new_date;
          break;
        case '1':
          var week_ = current.getDate() - 7;
          var last_week = new Date(current.setDate(week_));
          var end_week = new Date(current.setDate(current.getDate() + 7));
          var new_date = last_week.getFullYear() + '-' + ("0" + (last_week.getMonth() + 1)).slice(-2) + '-' + ("0" + last_week.getDate()).slice(-2);
          var end_date = end_week.getFullYear() + '-' + ("0" + (end_week.getMonth() + 1)).slice(-2) + '-' + ("0" + end_week.getDate()).slice(-2);
          break;
        case '2':
          var month_ = current.getMonth() - 1;
          var last_month = new Date(current.setMonth(month_));
          var end_month = new Date(current.setMonth(current.getMonth() + 1));
          var new_date = last_month.getFullYear() + '-' + ("0" + (last_month.getMonth() + 1)).slice(-2) + '-' + ("0" + last_month.getDate()).slice(-2);
          var end_date = end_month.getFullYear() + '-' + ("0" + (end_month.getMonth() + 1)).slice(-2) + '-' + ("0" + end_month.getDate()).slice(-2);
          break;
        default:
          var new_date = start_date;
      }

      var dateControl = document.querySelector('#startdate');
      dateControl.value = new_date;

      var dateControl2 = document.querySelector('#enddate');
      dateControl2.value = end_date;
    }
  });
</script>

<script text="text/javascript">
  $("#rightbutton").click(function () {

    var option = document.getElementById("timePeriod").value;
    var start_date = document.getElementById("startdate").value;
    var end_date = document.getElementById("enddate").value;
    var date_values = start_date.split("-");
    var year = parseInt(date_values[0]);
    var month = parseInt(date_values[1]) - 1;
    var date = parseInt(date_values[2]);
    var current = new Date(year, month, date);

    switch (option) {
      case '0':
        var tomorrow = new Date(current);
        tomorrow.setDate(tomorrow.getDate() + 1)
        var new_date = tomorrow.getFullYear() + '-' + ("0" + (tomorrow.getMonth() + 1)).slice(-2) + '-' + ("0" + tomorrow.getDate()).slice(-2);
        var end_date = new_date;
        break;
      case '1':
        var week_ = current.getDate() + 7;
        var next_week = new Date(current.setDate(week_));
        var end_week = new Date(current.setDate(current.getDate() + 7));
        var new_date = next_week.getFullYear() + '-' + ("0" + (next_week.getMonth() + 1)).slice(-2) + '-' + ("0" + next_week.getDate()).slice(-2);
        var end_date = end_week.getFullYear() + '-' + ("0" + (end_week.getMonth() + 1)).slice(-2) + '-' + ("0" + end_week.getDate()).slice(-2);
        break;
      case '2':
        var month_ = current.getMonth() + 1;
        var next_month = new Date(current.setMonth(month_));
        var end_month = new Date(current.setMonth(current.getMonth() + 1));
        var new_date = next_month.getFullYear() + '-' + ("0" + (next_month.getMonth() + 1)).slice(-2) + '-' + ("0" + next_month.getDate()).slice(-2);
        var end_date = end_month.getFullYear() + '-' + ("0" + (end_month.getMonth() + 1)).slice(-2) + '-' + ("0" + end_month.getDate()).slice(-2);
        break;
      default:
        var new_date = start_date;
    }

    var dateControl = document.querySelector('#startdate');
    dateControl.value = new_date;

    var dateControl2 = document.querySelector('#enddate');
    dateControl2.value = end_date;
  });
</script>

<script text="text/javascript">
  $("select[name = timePeriod]").on("change", function () {
    var date = new Date();
    var start_date;
    var end_date;
    //YYYY-MM-DD                      

    switch ($(this).val()) {
      case '0':
        var start_date = date.getFullYear() + '-' + ("0" + (date.getMonth() + 1)).slice(-2) + '-' + ("0" + date.getDate()).slice(-2);
        var end_date = start_date;
        break;
      case '1':
        var first = date.getDate() - date.getDay() + 1; // First day is the day of the month - the day of the week
        var last = first + 6;
        var firstDay = new Date(date.setDate(first));
        var lastDay = new Date(date.setDate(last));
        var start_date = firstDay.getFullYear() + '-' + ("0" + (firstDay.getMonth() + 1)).slice(-2) + '-' + ("0" + firstDay.getDate()).slice(-2);
        var end_date = lastDay.getFullYear() + '-' + ("0" + (lastDay.getMonth() + 1)).slice(-2) + '-' + ("0" + lastDay.getDate()).slice(-2);
        break;
      case '2':
        var firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        var lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        var start_date = firstDay.getFullYear() + '-' + ("0" + (firstDay.getMonth() + 1)).slice(-2) + '-' + ("0" + firstDay.getDate()).slice(-2);
        var end_date = lastDay.getFullYear() + '-' + ("0" + (lastDay.getMonth() + 1)).slice(-2) + '-' + ("0" + lastDay.getDate()).slice(-2);
        break;
      case '3':
        var tomorrow = new Date(date);
        tomorrow.setDate(tomorrow.getDate() + 1);
        var start_date = tomorrow.getFullYear() + '-' + ("0" + (tomorrow.getMonth() + 1)).slice(-2) + '-' + ("0" + tomorrow.getDate()).slice(-2);
        var end_date = start_date;
        break;
      default:
    }

    var dateControl = document.querySelector('#startdate');
    dateControl.value = start_date;
    //window.alert(dateControl.value);
    var dateControl2 = document.querySelector('#enddate');
    dateControl2.value = end_date;
  });
</script>
{% endblock %}