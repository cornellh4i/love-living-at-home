{% extends 'admin/request_manager/create_request.html' %}
{% import 'macros/form_macros.html' as f %}

{% block scripts %}
{% endblock %}

{% block create_request_content %}
{% set flashes = {
'error': get_flashed_messages(category_filter=['form-error']),
'warning': get_flashed_messages(category_filter=['form-check-email']),
'info': get_flashed_messages(category_filter=['form-info']),
'success': get_flashed_messages(category_filter=['form-success'])
} %}

{{ f.begin_form(form, flashes, extra_classes="large") }}
<div class="ui stackable centered grid container">
  <div class="twelve wide column">
    <h2 class="ui center aligned header">Transportation Request Form</h2>
  </div>

  <div class="twelve wide column">
    <div class="ui two column stackable grid">
      <div class="six wide column">
        {{ f.render_form_field(form.date_created) }}
      </div>
    </div>
  </div>

  <div class = "twelve wide column">
    <div class="ui two column stackable grid">
      <div class="ui two column row">
        <div class="ten wide column">
          {{ f.render_custom_select(form.destination) }}
        </div>
        <div class="right floated four wide column">
          <button
            type="button"
            class="ui inverted violet fluid button side-button"
            id="show-new-address-button"
          >
              Add new address
          </button>
        </div>
      </div>
      <div id = "new-address-modal" class = "ui modal">
        <form class = "ui form"></form>
        <center><h2 style = "padding: 10px">Add New Address</h2></center>
        <form class = "ui form" style = "padding: 10px">
          {{ form.csrf_token }}
          <div class="field">
            <label>Destination Address Name</label>
            <input type="text" id="address-name" required>
          </div>
          <div class = "field">
            <label>Street Address or P.O. Box</label>
            <input type="text" id="street-address" required>
          </div>
          <div class = "field">
            <label>Apt, suite, unit, building, floor, etc.</label>
            <input type="text" id="addr-cont">
          </div>
          <div class = "field">
            <label>City</label>
            <input type="text" id="city" required>
          </div>
          <div class = "field">
            <label>State</label>
            <input type="text" id="state" value="New York" required>
          </div>
          <div class = "field">
            <label>Country</label>
            <input type="text" id="country" value="United States"required>
          </div>
          <div class = "field">
            <label>Zip Code</label>
            <input type="text" id="zip">
          </div>
          <button class = "ui button" id = "address-modal-submit" onclick = "sendAddressFormData()">Submit</button>
        </form>
      </div>
    </div>
  </div>

  <div class="twelve wide column">
    {{ f.render_form_field(form.requesting_member)}}
  </div>

  <div class="twelve wide column">
    <div class="ui two column stackable relaxed grid">
      <div class="two column row">
        <div class="six wide column">
          {{ f.render_form_field(form.requested_date) }}
        </div>
        <div class="right floated six wide column">
          {{ f.render_form_field(form.time_flexible) }}
        </div>
      </div>
      <div class="two column row">
        <div class="six wide column">
          {{ f.render_form_field(form.initial_pickup) }}
        </div>
        <div class="right floated six wide column">
          {{ f.render_form_field(form.return_pickup) }}
        </div>
      </div>
      <div class="two column row">
        <div class="six wide column">
          {{ f.render_form_field(form.appointment) }}
        </div>
        <div class="right floated six wide column">
          {{ f.render_form_field(form.drop_off) }}
        </div>
      </div>
    </div>
  </div>

  <div class="twelve wide column">
    {{ f.render_form_field(form.description) }}
  </div>

  <div class="twelve wide column">
    <div class="ui two column stackable grid">
      <div class="six wide column">
        {{ f.render_form_field(form.service_category) }}
      </div>
      <div class="right floated six wide column">
        <div id="covid" style="display: none">
          {{ f.render_form_field(form.covid_service) }}
        </div>
        <div id="transportation">
          {{ f.render_form_field(form.transportation_service) }}
        </div>
      </div>
      <div class="right floated six wide column"></div>
    </div>

    <style>
      .column {
        position: relative;
      }

      .column .side-button {
        position: absolute;
        bottom: 0;
        left: 0;
      }
    </style>

    <div>{{ f.render_form_field(form.starting_location) }}</div>

    {{ f.render_form_field(form.duration) }}

    <div id = "providers" class="twelve wide column">
      {{ f.render_form_field(form.service_provider)}}
    </div>

    <script>
      $('#show-new-address-button').click(() => {
        $('#new-address-modal').modal('show');
      })

       function sendAddressFormData() {
         let fields = ["address-name", "street-address", "addr-cont", "city", "state", "country", "zip"]
         let required = new Set(["address-name", "street-address", "city", "state","country"])
         let queryJSON = {};

         for (let i = 0; i < fields.length; i++) {
           const input = document.getElementById(fields[i]);
           if (required.has(fields[i]) && input.value === ""){
             return;
           }
           queryJSON[fields[i]] = input.value;
         }

         const protocol = window.location.protocol;
         const host = window.location.host;
         fetch(`${protocol}//${host}/admin/add-transportation-address`, {
           method: "POST",
           headers: {
                "Accept": "application/json",
                "Content-Type": "application/json",
                "X-CSRFToken": document.getElementById("csrf_token").value,
            },
            body: JSON.stringify(queryJSON)
         })
       }
     </script>

    <div class="four fields" style = "margin-top: 10px">
      <div class="field">
        <button id="show-send-req-modal" class="ui purple basic button" type="button">
          Send Request
        </button>
        <div id="send-req-modal" class="ui modal">
          <i class="close icon"></i>
          <div class="header">Are you sure you'd like to send this request?</div>
          <div class="content">
            <h4>A blank email will be sent if you haven't yet created the request<h4>
            <button onclick="sendRequests('send+request')" class="ui purple basic button" type="button">
              Send Request
            </button>
            <div id = "send-request-success-message" class="ui hidden positive message">
              <i class="close icon"></i>
              <div class="header">
                Request sent
              </div>
              <p>The volunteers have been emailed!</p>
            </div>
          </div>
        </div>
      </div>
      <div class="field">
        <button id = "show-confirmation-modal" class="ui purple basic button" type="button">
          Confirmation
        </button>
        <div id="confirmation-modal" class="ui modal">
          <i class="close icon"></i>
          <div class="header">Are you sure you'd like to send a confirmation email?</div>
          <div class="content">
            <h4>A blank email will be sent if you haven't yet created the request<h4>
            <button onclick="sendRequests('confirmation')" class="ui purple basic button" type="button">
              Confirmation
            </button>
            <div id = "confirmation-success-message" class="ui hidden positive message">
              <i class="close icon"></i>
              <div class="header">
                Confirmation sent
              </div>
              <p>The volunteers have been emailed!</p>
            </div>
          </div>
        </div>
      </div>
      <div class="field">
        <button id = "show-not-needed-modal" class="ui purple basic button" type="button">
          Not Needed
        </button>
        <div id="not-needed-modal" class="ui modal">
          <i class="close icon"></i>
          <div class="header">Are you sure you'd like to send a not needed email?</div>
          <div class="content">
            <h4>A blank email will be sent if you haven't yet created the request<h4>
            <button onclick="sendRequests('not+needed')" class="ui purple basic button" type="button">
              Not Needed
            </button>
            <div id = "not-needed-success-message" class="ui hidden positive message">
              <i class="close icon"></i>
              <div class="header">
                Request sent
              </div>
              <p>The volunteers have been emailed!</p>
            </div>
          </div>
        </div>
      </div>
      <div class="field">
        <button id = "show-summary-modal" class="ui purple basic button" type="button">
          Summary
        </button>
        <div id="summary-modal" class="ui modal">
          <i class="close icon"></i>
          <div class="header">Are you sure you'd like to send a summary email?</div>
          <div class="content">
            <h4>A blank email will be sent if you haven't yet created the request<h4>
            <button onclick="sendRequests('summary')" class="ui purple basic button" type="button">
              Send Summary
            </button>
            <div id = "summary-success-message" class="ui hidden positive message">
              <i class="close icon"></i>
              <div class="header">
                Request sent
              </div>
              <p>The volunteers have been emailed!</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <p id="special-instructions" style="display: none">
    {{form.special_instructions_list}}
  </p>

  <div class="twelve wide column">
    <div class="field" id="special-instructions-div">
      {{ f.render_form_field(form.special_instructions) }}
    </div>
  </div>

  <div class="twelve wide column">
    <div class="ui two column stackable grid">
      <div class="six wide column">
        {{ f.render_form_field(form.follow_up_date) }} {{
        f.render_form_field(form.responsible_staffer) }}
      </div>
      <div class="right floated six wide column">
        {{ f.render_form_field(form.status) }} {{
        f.render_form_field(form.contact_log_priority) }}
      </div>
    </div>
  </div>

  <div class="twelve wide column">
    {{ f.render_form_field(form.person_to_cc) }}
  </div>

  <div id="new-service-provider" class="ui modal">
    <i class="close icon"></i>
    <div class="header">Add Service Provider</div>
    <div class="content">
      <h3>Add New Service Provider</h3>
    </div>
  </div>

<!--
  <div id="new-destination" class="ui modal">
    <i class="close icon"></i>
    <div class="header">Add New Destination</div>
    <div class="content">
      <h3>Add a New Address</h3>
      <div class="ui stackable centered grid container">
        <div class="twelve wide column">
          {{f.render_form_field(form.destination_name)}}
          {{f.render_form_field(form.street_address1)}}
          {{f.render_form_field(form.street_address2)}}
          {{f.render_form_field(form.city)}}
        </div>
        <div class="two column row">
          <div class="six wide column">{{f.render_form_field(form.state)}}</div>
          <div class="six wide column">{{f.render_form_field(form.zip)}}</div>
        </div>
        <div class="two column row">
          <div class="six wide column">
            {{f.render_form_field(form.country)}}
          </div>
          <div class="six wide column">
            {{f.render_form_field(form.add_address)}}
          </div>
        </div>
      </div>
    </div>
  </div> -->

  <!-- Begin Modal Logic -->
  <script>
    // $('#show-new-destination').click(function () {
    //   $('#new-destination').modal('show');
    // });

    $('#show-new-service-provider').click(() => {
      $('#new-service-provider').modal('show');
    });

    $('#show-send-req-modal').click(() => {
      $('#send-req-modal').modal('show');
    });

    $('#show-confirmation-modal').click(() => {
      $('#confirmation-modal').modal('show');
    });

    $('#show-not-needed-modal').click(() => {
      $('#not-needed-modal').modal('show');
    });

    $('#show-summary-modal').click(() => {
      $('#summary-modal').modal('show');
    })
  </script>
  <!-- End Modal logic -->

  <script>
    function serviceChoices() {
      let service_category = document.getElementById('service_category').value;
      if (service_category === '1') {
        document.getElementById('covid').style.display = 'initial';
        document.getElementById('transportation').style.display = 'none';
      } else if (service_category === '0') {
        document.getElementById('covid').style.display = 'none';
        document.getElementById('transportation').style.display = 'initial';
      }
    }

    function specialInstructions() {
      let member_id = document.getElementById('member').value.toString();
      $('#special-instructions-div').empty();
      let str = document.getElementById('special-instructions').innerHTML;
      let obj = JSON.parse(str);
      $('#special-instructions-div').append(
        '<label class = "ui form field">Special Instructions:</label>'
      );
      $('#special-instructions-div').append(
        '<textarea name="special_instructions" class="ui textArea" >' +
          obj[member_id] +
          '</textarea>'
      );
      special_input = obj[member_id];
    }
  </script>

  <!-- Begin Table logic -->
  <script>
    const providerSelect = document.getElementById("service_provider");
    function updateTable() {
      const providerDiv = document.getElementById("providers");
      let selectedNames = [];
      for (const option of providerSelect.options) {
        if (option.selected)
          selectedNames.push(option.innerHTML)
      }

      const table = document.createElement('table');
      if (selectedNames.length > 0) {
        table.className += "ui celled table";
        const header = table.createTHead();
        const row = header.insertRow(0);
        const headers = ["Name", "Address", "Location", "Phone Number", "Contact Method", "Type", "Last/Next Svc. Date", "Fully Vetted", "Rating", "Actions"]
        row.insertCell(0);
        for (let i = 1; i < headers.length; i++) {
          const tempHeaderCell = row.insertCell(i);
          tempHeaderCell.innerHTML = "<b>" + headers[i - 1] + "</b>";
        }
        table.id = "volunteerDataTable";
      }

      const volDataArr = {{ volunteer_data | safe }}

      for (const volName of selectedNames) {
        const row = table.insertRow(1);
        const boxEntry = row.insertCell(0);
        const checkBox = document.createElement("INPUT");
        checkBox.setAttribute("type", "checkbox");
        checkBox.className += "ui checkbox";
        checkBox.name = "selectedVolunteersCheckBox";
        volDataArr.find(vol => {
          if (vol[0] == volName)
           checkBox.value = vol[3] + "|" + vol[6];
        })
        boxEntry.appendChild(checkBox);
        const volunteer = volDataArr.find(volObj => volObj[0] == volName);
        for (let i = 0; i < volunteer.length; i++) {
          const tempVolData = row.insertCell(i + 1);
          tempVolData.innerHTML = volunteer[i];
        }
      }

      if (!document.getElementById("volunteerDataTable")) {
        providerDiv.prepend(table);
      } else {
        providerDiv.replaceChild(table, document.getElementById("volunteerDataTable"));
      }
    }
    providerSelect.setAttribute("onchange", "updateTable()");

    function sendRequests(buttonType) {
      const checkBoxStates = document.getElementsByName("selectedVolunteersCheckBox");
      const checkBoxArr = Array.prototype.slice.call(checkBoxStates);
      const volunteersToReq = checkBoxArr.filter(box => box.checked);
      let emails = ""
      for (const vol of volunteersToReq)
        emails += vol.value.split("|")[1] + "&";

      emails = emails.substring(0, emails.length - 1);

      const websiteHost = window.location.host;
      const protocol = window.location.protocol;
      fetch(`${protocol}//${websiteHost}/admin/create-request/send-emails?${buttonType}&-1&Transportation&${emails}`);

      const buttonId = `${buttonType.replace('+', '-') + '-success-message'}`
      document.getElementById(buttonId).classList.remove('hidden');
      document.getElementById(buttonId).classList.add('visible');
    }
  </script>
  <!-- End Table logic -->

  <div class="twelve wide column">
    {{ f.form_message(flashes['error'], header='Something went wrong.', class='error') }}
    {{ f.form_message(flashes['warning'], header='Check your email.', class='warning') }}
    {{ f.form_message(flashes['info'], header='Information', class='info') }}
    {{ f.form_message(flashes['success'], header='Success!', class='success') }}

    {{ f.render_form_field(form.submit, extra_classes=".ui .button") }}

    {{ f.end_form() }}
  </div>
</div>

{% endblock %}
