{% extends 'layouts/base.html' %}
{% import 'macros/form_macros.html' as f %}

<!-- Macros -->
{% macro dashboard_option(title, endpoint,
description=None, icon=None) %}
<a class="column" href="{{ url_for(endpoint) }}">
  <div class="ui padded segment">
    <h3 class="ui header">
      {% if icon is not none %}
      <i class="{{ icon }}"></i>
      {% endif %}
      <div class="content">
        {{ title }} {% if description is not none %}
        <div class="sub header">{{ description }}</div>
        {% endif %}
      </div>
    </h3>
  </div>
</a>
{% endmacro %}

{% macro member_card(m) %}
<div class="content">
  {% if m.middle_initial %}
  {% set name = m.first_name + ' ' + m.middle_initial + '. ' + m.last_name %}
  {% else %}
  {% set name = m.first_name + ' ' + m.last_name %}
  {% endif %}
  <div class="header">{{ name + " (" + m.member_number|string + ")"}}
    <i class="trash alternate outline icon right floated delete-member" style="cursor: pointer" id={{m.id}}></i>

    <div class="ui modal" id='modal-{{m.id}}'>
      <div class="header">Delete Member</div>
      <div class="content">Would you like to delete Member [{{m.first_name + ' ' + m.last_name}}]?</div>
      <div class="actions">
        <div class="positive ui approve button"
          onclick="window.location.href = '{{ url_for('admin.delete_member', member_id=m.id) }}';">
          Yes
        </div>
        <div class="negative ui deny button">No</div>
      </div>
    </div>

    <i class="pencil icon right floated" style="cursor: pointer"
      onclick="window.location.href = '{{ url_for('admin.invite_member', member_id=m.id) }}';">
    </i>
  </div>
</div>
{% endmacro %}

{% macro volunteer_card(v) %}
{% if v.middle_initial %}
{% set name = v.first_name + ' ' + v.middle_initial + '. ' + v.last_name %}
{% else %}
{% set name = v.first_name + ' ' + v.last_name %}
{% endif %}
<div class="content">
  <div class="header">{{ name }}
    <i class="trash alternate outline icon right floated delete-volunteer" style="cursor: pointer" id={{v.id}}></i>

    <div class="ui modal" id='modal-{{v.id}}'>
      <div class="header">Delete Volunteer</div>
      <div class="content">Would you like to delete Volunteer [{{v.first_name + ' ' + v.last_name}}]?</div>
      <div class="actions">
        <div class="positive ui approve button"
          onclick="window.location.href = '{{ url_for('admin.delete_volunteer', volunteer_id=v.id) }}';">
          Yes
        </div>
        <div class="negative ui deny button">No</div>
      </div>
    </div>

    <i class="comment outline icon right floated" style="cursor: pointer"></i>
    <i class="clock outline icon right floated" style="cursor: pointer"
      onclick="window.location.href = '{{ url_for('admin.add_availability_volunteer', volunteer_id=v.id) }}';"></i>
    <i class="calendar minus outline icon right floated" style="cursor: pointer"></i>
    <i class="check square outline icon right floated" style="cursor: pointer"
      onclick="window.location.href = '{{ url_for('admin.add_volunteer_vetting', volunteer_id=v.id) }}';"></i>
    <i class="handshake outline icon right floated" style="cursor: pointer"
      onclick="window.location.href = '{{ url_for('admin.add_volunteer_services', volunteer_id=v.id) }}';"></i>
    <i class="pencil icon right floated" style="cursor: pointer"
      onclick="window.location.href = '{{ url_for('admin.invite_volunteer', volunteer_id=v.id) }}';">
    </i>
  </div>
</div>
<div class="content ui grid" style="padding:0">

  <div class="four wide column">
    <div class="ui label">
      {% if v.type_id == 0 %}
      Member Volunteer
      {% else %}
      Non-Member Volunteer
      {% endif %}
    </div>
  </div>
  <div class="four wide column">
    {% if v.is_fully_vetted %}
    <div class="ui label green">
      <i class="check icon"></i>Fully Vetted
    </div>
    {% else %}
    <div class="ui label red">
      <i class="x icon"></i>Not Fully Vetted
    </div>
    {% endif %}
  </div>
  <div class="four wide column">
  </div>
  <div class="four wide column right aligned">
    {{v.primary_phone_number}}
  </div>
</div>
{% endmacro %}

{% macro local_resource_card(lr) %}
<div class="content">
  <div class="header">{{lr.company_name}}
    <i class="trash alternate outline icon right floated delete-local-resource" style="cursor: pointer" id={{lr.id}}></i>

    <div class="ui modal" id='modal-{{lr.id}}'>
      <div class="header">Delete Local Resource</div>
      <div class="content">Would you like to delete Local Resource [{{lr.company_name}}]?</div>
      <div class="actions">
        <div class="positive ui approve button"
          onclick="window.location.href = '{{ url_for('admin.delete_local_resource', local_resource_id=lr.id) }}';">
          Yes
        </div>
        <div class="negative ui deny button">No</div>
      </div>
    </div>

    <i class="comment outline icon right floated" style="cursor: pointer"></i>
    <i class="clock outline icon right floated" style="cursor: pointer"
      onclick="window.location.href = '{{ url_for('admin.add_availability_local_resource', local_resource_id=lr.id) }}';"></i>
    <i class="pencil icon right floated" style="cursor: pointer"
      onclick="window.location.href = '{{ url_for('admin.invite_contractor', local_resource_id=lr.id) }}';"></i>
  </div>
</div>
<div class="content ui grid" style="padding:0">
  <div class="four wide column">
    {% if lr.contact_first_name and lr.contact_last_name %}
    <b>Contact:</b>
    {{lr.contact_first_name + ' ' + lr.contact_last_name}}
    {% else %}
    <i>No contact person</i>
    {% endif %}
  </div>
  <div class="eight wide column">
  </div>
  <div class="four wide column right aligned">{{lr.primary_phone_number}}</div>
</div>
{% endmacro %}

<!-- Content -->
{% block content %}
<style>
  .highlight {
    background-color: lightblue;
  }

  #calendar-body td:empty {
    cursor: text;
    border: none;
  }

  #calendar-body td {
    cursor: pointer;
  }

  #calendar thead {
    border-bottom: 2px solid #cecece;
  }

  #calendar th {
    border: none;
    text-align: center;
    padding: 0;
    width: 10%;
  }

  #calendar td {
    border: 1px solid rgba(0, 0, 0, .125);
    text-align: center;
    padding: 5px;
    width: 10%;
  }

  .previous {
    margin-top: 4%;
    margin-left: 2%;
  }

  .next {
    margin-top: 4%;
    margin-right: 2%;
  }

  .round {
    border-radius: 50%;
  }

  .month-selected {
    font-family: inherit;
    font-weight: 500;
    line-height: 1.2;
    color: inherit;
  }

  a:hover {
    text-decoration: none;
  }


  #calendar-header {
    margin-bottom: 0px;
    background-color: #e7e7e7;
    border-bottom: 1px solid rgba(0, 0, 0, .125);
  }

  .header-row {
    background-color: lightgray;
    margin: 0px;
    padding: 5px;
  }

  #monthAndYear {
    border-bottom: none;
    background-color: transparent;
    padding-left: 14px;
    padding-right: 14px;
    display: none;
  }

  #previous,
  #next {
    color: darkslategrey;
  }

  .today-color {
    background-color: #D3D3D3;
  }

  #parent {
    border: 2px dotted rgba(0, 0, 0, .125);
    border-radius: .25rem;
    padding: 5px;
  }

  .buttonPanel td {
    border: none !important;
    padding: 6px 0 0 0 !important;
  }

  .buttonPanel td div:nth-of-type(odd) {
    padding: 5px;
    width: 100%;
    text-align: left;
  }

  .buttonPanel td div:nth-of-type(even) {
    padding: 5px;
    width: 100%;
    text-align: right;
  }

  .buttonPanel-row {
    margin: 0;
    border-top: 2px solid lightgray;
  }

  #calendarBody {
    cursor: pointer;
    user-select: none;
  }
</style>

<div class="ui container">
  <h2 class="ui header">People Manager</h2>

  <div class="ui tabular menu">
    <a class="active item" data-tab="member">Members</a>
    <a class="item" data-tab="volunteer">Volunteers</a>
    <a class="item" data-tab="local-resource">Local Resources</a>
  </div>
  
  <!-- Member Tab -->
  <div class="active ui tab" data-tab="member">
    <div class="ui stackable centered grid container">
      <div class="four wide column">
        {{ dashboard_option('Add Member', 'admin.invite_member', icon='add user icon') }}
        
        <!-- Search Box -->
        <h3>Search:</h3>
        <div class="ui search item">
          <div class="ui transparent icon input">
            <input id="search-people" type="text" placeholder="Enter name...">
            <i class="search icon"></i>
          </div>
        </div>

        <!-- Filter Box -->
        <h3>Filters</h3>
        <div class="attached ui top segment">
          <form class="ui form" id="member-filter-form">
            <div class="grouped fields">
              <label>Volunteer Type:</label>
              <div class="field">
                <div class="ui checkbox">
                  <input type="checkbox" name="volunteer_type" />
                  <label>Member</label>
                </div>
              </div>
              <div class="field">
                <div class="ui checkbox">
                  <input type="checkbox" name="volunteer_type" />
                  <label>Non-Member</label>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Search Results -->
      <div class="twelve wide column">
        <h3>Search Results</h3>
        <div class="ui segment search-results">
          {% for m in members %}
          <div class="ui fluid card" data-role={{"Member"}}>
            {{member_card(m)}}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- Volunteer Tab -->
  <div class="ui tab" data-tab="volunteer">
    <div class="ui stackable centered grid container">
      <div class="four wide column">
        {{ dashboard_option('Add Volunteer', 'admin.invite_volunteer', icon='add user icon') }}
        
        <!-- Search Box -->
        <h3>Search:</h3>
        <div class="ui search item">
          <div class="ui transparent icon input">
            <input id="search-people" type="text" placeholder="Enter name...">
            <i class="search icon"></i>
          </div>
        </div>

        <!-- Filter Box -->
        <h3>Filters</h3>
        <div class="attached ui top segment">
          <form class="ui form" id="member-filter-form">
            <div class="grouped fields">
              <label>Vetting Status:</label>
              <div class="field">
                <div class="ui checkbox">
                  <input type="checkbox" name="volunteer_type" />
                  <label>Fully Vetted</label>
                </div>
              </div>
              <div class="field">
                <div class="ui checkbox">
                  <input type="checkbox" name="volunteer_type" />
                  <label>Not Fully Vetted</label>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Search Results -->
      <div class="twelve wide column">
        <h3>Search Results</h3>
        <div class="ui segment search-results">
          {% for v in volunteers %}
          <div class="ui fluid card" data-role={{"Volunteer"}}>
            {{volunteer_card(v)}}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Local Resource Tab -->
  <div class="ui tab" data-tab="local-resource">
    <div class="ui stackable centered grid container">
      <div class="four wide column">
        {{ dashboard_option('Add Local Resource', 'admin.invite_contractor', icon='add user icon') }}
        
        <!-- Search Box -->
        <h3>Search:</h3>
        <div class="ui search item">
          <div class="ui transparent icon input">
            <input id="search-people" type="text" placeholder="Enter name...">
            <i class="search icon"></i>
          </div>
        </div>
      </div>

      <!-- Search Results -->
      <div class="twelve wide column">
        <h3>Search Results</h3>
        <div class="ui segment search-results">
          {% for lr in local_resources %}
          <div class="ui fluid card" data-role={{"Local Resource"}}>
            {{local_resource_card(lr)}}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

    <!-- Service Categories Pop Up 
    <div class="ui modal" id="services">
      <i class="close icon"></i>
      <div class="header">Services Provided By</div>
      {% set flashes =
      { 'error': get_flashed_messages(category_filter=['form-error']),
      'warning': get_flashed_messages(category_filter=['form-check-email']),
      'info': get_flashed_messages(category_filter=['form-info']),
      'success': get_flashed_messages(category_filter=['form-success']) }
      %}
      {{ f.begin_form(service_form, flashes) }}
      <div class="content">
        <div class="ui styled fluid accordion">
          {% for key, value in category_dict.items() %}
          <div class="title">
            <i class="dropdown icon"></i>
            {{ key }}
          </div>
          <div class="content">
            {{ service_form|attr(key)() }}
          </div>
          {% endfor %}
        </div>
        <div class="actions">
          {{ f.form_message(flashes['error'], header='Something went wrong.',
          class='error') }}
          {{ f.form_message(flashes['warning'], header='Check your
          email.', class='warning') }}
          {{ f.form_message(flashes['info'],
          header='Information', class='info') }}
          {{ f.form_message(flashes['success'],
          header='Success!', class='success') }}
          {{ f.render_form_field(service_form.submit) }}
        </div>
      </div>
      {{ f.end_form() }}
    </div>-->

    <!-- Reviews Pop Up -->
    <div class="ui modal" id="reviews">
      <i class="close icon"></i>
      <div class="header">Reviews</div>

      {% set flashes = { 'error':
      get_flashed_messages(category_filter=['form-error']), 'warning':
      get_flashed_messages(category_filter=['form-check-email']), 'info':
      get_flashed_messages(category_filter=['form-info']), 'success':
      get_flashed_messages(category_filter=['form-success']) } %} {{
      f.begin_form(reviews, flashes) }}

      <div class="ui styled fluid accordion">
        <div class="active title">
          <i class="dropdown icon"></i>
          Add A Review
        </div>
        <div class="active content">
          <div class="two fields">
            <div class="field">
              {{ f.render_form_field(reviews.reviewer_name) }}
            </div>
            <div class="field">
              <label>Rating:</label>
              <div class="ui massive star rating" data-max-rating="5"></div>
            </div>
          </div>
          {{ f.render_form_field(reviews.notes) }}
        </div>
        <div class="title">
          <i class="dropdown icon"></i>
          Previous Reviews
        </div>
        <div class="content">
          <div class="transition hidden">
            <div class="ui form">{{ f.render_form_field(reviews.notes) }}</div>
          </div>
        </div>

        <div class="actions">
          {{ f.form_message(flashes['error'], header='Something went wrong.',
          class='error') }}
          {{ f.form_message(flashes['warning'], header='Check your
          email.', class='warning') }}
          {{ f.form_message(flashes['info'],
          header='Information', class='info') }}
          {{ f.form_message(flashes['success'],
          header='Success!', class='success') }}
          {{f.render_form_field(reviews.submit) }}
        </div>
        {{ f.end_form() }}

      </div>
    </div>

    <!-- Vacation Calendar Pop Up -->
    <div class="ui modal" id="vacation_calendar">
      <i class="close icon"></i>
      <div class="header">Vacation Calendar</div> 

      <!-- Calendar Code -->
      <div id="parent" class="ui container" style="display:none;">
        <div class="ui cards">
          <div class="ui centered card">
            <div class="ui header mini form" id="calendar-header">
              <div class="four fields">
                <div class="field previous">
                  <a href="#" id="previous" onclick="previous()">
                    <i class="ui icon angle left" aria-hidden="true"></i>
                  </a>
                </div>
                <div class="field">
                  <select class="fluid" name="month" id="month" onchange="change()">
                  </select>
                </div>
                <div class="field">
                  <select class="ui dropdown fluid" name="year" id="year" onchange="change()">
                  </select>

                </div>
                <div class="field next">
                  <a href="#" id="next" onclick="next()">
                    <i class="ui icon angle right" aria-hidden="true"></i>
                  </a>
                </div>
              </div>
            </div>
            <div class="description">
              <table id="calendar">
                <thead>
                  <tr>
                    <th>S</th>
                    <th>M</th>
                    <th>T</th>
                    <th>W</th>
                    <th>T</th>
                    <th>F</th>
                    <th>S</th>
                  </tr>
                </thead>
                <tbody id="calendarBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>


  <script language='javascript'>
    $(document).ready(function () {
      $('.ui.accordion').accordion();
      $('.ui.checkbox').checkbox();
    });

    $(document)
      .ready(function () {
        $('.menu .item').tab();
        
        // function filterPeople() {
        //   let peopleFilter = $('#role-field').val();
        //   $('.card').each(function () {
        //     $this = $(this);
        //     $this.show();

        //     // Filter by role
        //     let role = this.getAttribute('data-role');
        //     if (role != peopleFilter) {
        //       $this.hide();
        //     }
        //   });
        // }
        
        // $('#search-people').keyup(function () {
        //   //   filterPeople();
        //   var searchText = $(this).val();
        //   if (searchText.length > 0) {
        //     $('.search-results .header:icontains(' + searchText + ')').closest('.card').addClass('positive');
        //     $('.card.positive .header').not(':icontains(' + searchText + ')').removeClass('positive');
        //     $('.search-results .header').not(':icontains(' + searchText + ')').closest('.card').addClass('hidden').hide();
        //     $('.card.hidden .header:icontains(' + searchText + ')').removeClass('hidden').show();
        //   } else {
        //     $('.card.positive').removeClass('positive');
        //     $('.card.hidden').removeClass('hidden').show();
        //   }
        // });

      });

      $(document).ready(function(){
          $('.ui .item').on('click', function() {
              $('.ui .item').removeClass('active');
              $(this).addClass('active');
          });             
      });


    $('.tab #search-people').keyup(function () {
        //   filterPeople();
        var searchText = $(this).val();
        if (searchText.length > 0) {
          $('.search-results .header:icontains(' + searchText + ')').closest('.card').addClass('positive');
          $('.card.positive .header').not(':icontains(' + searchText + ')').removeClass('positive');
          $('.search-results .header').not(':icontains(' + searchText + ')').closest('.card').addClass('hidden').hide();
          $('.card.hidden .header:icontains(' + searchText + ')').removeClass('hidden').show();
        } else {
          $('.card.positive').removeClass('positive');
          $('.card.hidden').removeClass('hidden').show();
        }
      });

    $('i.handshake.outline.icon.right.floated').click(function () {
      $('#services').modal('show');
    });

    $('#context1.menu.item').tab({
      context: $('#context1'),
    });

    $('i.calendar.minus.outline.icon.right.floated').click(function () {
      $('#vacation_calendar').modal('show');
    });    

    $('i.comment.outline.icon.right.floated').click(function () {
      $('#reviews').modal('show');
    });

    $('.ui.accordion').accordion({ exclusive: false });

    $('.ui.rating').rating();

    $('.delete-member').click(function () {
      member_id = $(this).attr('id');
      $(`#modal-${member_id}`).modal('show');
    });

    $('.delete-volunteer').click(function () {
      volunteer_id = $(this).attr('id');
      $(`#modal-${volunteer_id}`).modal('show');
    });

    $('.delete-local-resource').click(function () {
      local_resource_id = $(this).attr('id');
      $(`#modal-${local_resource_id}`).modal('show');
    });

  </script>

  {% endblock %}