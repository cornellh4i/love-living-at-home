{% extends 'layouts/base.html' %}
{% import 'macros/form_macros.html' as f %}

<!-- Macros -->
{% macro dashboard_option(title, endpoint,
description=None, icon=None) %}
<a class="column" href="{{ url_for(endpoint) }}">
  <div class="ui padded segment">
    <h3 class="ui header">
      {% if icon is not none %}
      <i class="{{ icon }}"></i>
      {% endif %}
      <div class="content">
        {{ title }} {% if description is not none %}
        <div class="sub header">{{ description }}</div>
        {% endif %}
      </div>
    </h3>
  </div>
</a>
{% endmacro %}

{% macro member_card(m) %}
<div class="content">
  {% if m.middle_initial %}
  {% set name = m.first_name + ' ' + m.middle_initial + '. ' + m.last_name %}
  {% else %}
  {% set name = m.first_name + ' ' + m.last_name %}
  {% endif %}
  <div class="header">{{ name + " (" + m.member_number|string + ")"}}
    <i class="trash alternate outline icon right floated" style="cursor: pointer"></i>
    <i class="pencil icon right floated" style="cursor: pointer"
      onclick="window.location.href = '{{ url_for('admin.invite_member', member_id=m.id) }}';">
    </i>
  </div>
</div>
{% endmacro %}

{% macro volunteer_card(v) %}
{% if v.middle_initial %}
{% set name = v.first_name + ' ' + v.middle_initial + '. ' + v.last_name %}
{% else %}
{% set name = v.first_name + ' ' + v.last_name %}
{% endif %}
<div class="content">
  <div class="header">{{ name }}
    <i class=" comment outline icon right floated" style="cursor: pointer"></i>
    <i class="clock outline icon right floated" style="cursor: pointer"></i>
    <i class="check square outline icon right floated" style="cursor: pointer"></i>
    <i class="handshake outline icon right floated" style="cursor: pointer"></i>
    <i class="pencil icon right floated" style="cursor: pointer"
      onclick="window.location.href = '{{ url_for('admin.invite_volunteer', volunteer_id=v.id) }}';">
    </i>
  </div>
</div>
<div class="content ui grid" style="padding:0">

  <div class="four wide column">
    <div class="ui label">
      {% if v.type_id == 0 %}
      Member Volunteer
      {% else %}
      Non-Member Volunteer
      {% endif %}
    </div>
  </div>
  <div class="four wide column">
    {% if v.is_fully_vetted %}
    <div class="ui label green">
      <i class="check icon"></i>Fully Vetted
    </div>
    {% else %}
    <div class="ui label red">
      <i class="x icon"></i>Not Fully Vetted
    </div>
    {% endif %}
  </div>
  <div class="four wide column">

  </div>
  <div class="four wide column right aligned">
    {{v.primary_phone_number}}
  </div>
</div>
{% endmacro %}

{% macro local_resource_card(lr) %}
<div class="content">
  <div class="header">{{lr.company_name}}
    <i class="pencil icon right floated" style="cursor: pointer"
      onclick="window.location.href = '{{ url_for('admin.invite_contractor', local_resource_id=lr.id) }}';"></i>
  </div>
</div>
<div class="content">~info about local resource~</div>
{% endmacro %}

<!-- Content -->
{% block content %}
<div class="ui container">
  <h2 class="ui header">People Manager</h2>

  <div class="ui tabular menu">
    <a class="item active" data-tab="member">Members</a>
    <a class="item" data-tab="volunteer">Volunteers</a>
    <a class="item" data-tab="local-resource">Local Resources</a>
  </div>
  <div class="ui tab active" data-tab="member">
    <div class="ui stackable centered grid container">
      <div class="four wide column">
        {{ dashboard_option('Add Member', 'admin.invite_member', icon='add user icon') }}

        <h3>Search:</h3>
        <div class="ui search item">
          <div class="ui transparent icon input">
            <input id="search-people" type="text" placeholder="Enter name...">
            <i class="search icon"></i>
          </div>
        </div>
        <h3>Filters</h3>
        <div class="attached ui top segment">
          <form class="ui form" id="member-filter-form">
            <div class="grouped fields">
              <label>Volunteer Type:</label>
              <div class="field">
                <div class="ui checkbox">
                  <input type="checkbox" name="volunteer_type" />
                  <label>Member</label>
                </div>
              </div>
              <div class="field">
                <div class="ui checkbox">
                  <input type="checkbox" name="volunteer_type" />
                  <label>Non-Member</label>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="twelve wide column">
        <h3>Search Results</h3>
        <div class="ui segment search-results">
          {% for m in members %}
          <div class="ui fluid card" data-role={{"Member"}}>
            {{member_card(m)}}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div class="ui tab" data-tab="volunteer">
    <div class="ui stackable centered grid container">
      <div class="four wide column">
        {{ dashboard_option('Add Volunteer', 'admin.invite_volunteer', icon='add user icon') }}
        <h3>Search:</h3>
        <div class="ui search item">
          <div class="ui transparent icon input">
            <input id="search-people" type="text" placeholder="Enter name...">
            <i class="search icon"></i>
          </div>
        </div>
      </div>

      <div class="twelve wide column">
        <h3>Search Results</h3>
        <div class="ui segment search-results">
          {% for v in volunteers %}
          <div class="ui fluid card" data-role={{"Volunteer"}}>
            {{volunteer_card(v)}}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <!-- Service Categories Pop Up -->
    <div class="ui modal" id="services">
      <i class="close icon"></i>
      <div class="header">Services Provided By</div>
      {% set flashes =
      { 'error': get_flashed_messages(category_filter=['form-error']),
      'warning': get_flashed_messages(category_filter=['form-check-email']),
      'info': get_flashed_messages(category_filter=['form-info']),
      'success': get_flashed_messages(category_filter=['form-success']) }
      %}
      {{ f.begin_form(service_form, flashes) }}
      <div class="content">
        <div class="ui styled fluid accordion">
          {% for key, value in category_dict.items() %}
          <div class="title">
            <i class="dropdown icon"></i>
            {{ key }}
          </div>
          <div class="content">
            {{ service_form|attr(key)() }}
          </div>
          {% endfor %}
        </div>
        <div class="actions">
          {{ f.form_message(flashes['error'], header='Something went wrong.',
          class='error') }}
          {{ f.form_message(flashes['warning'], header='Check your
          email.', class='warning') }}
          {{ f.form_message(flashes['info'],
          header='Information', class='info') }}
          {{ f.form_message(flashes['success'],
          header='Success!', class='success') }}
          {{ f.render_form_field(service_form.submit) }}
        </div>
      </div>
      {{ f.end_form() }}
    </div>

    <!-- Vettings Pop Up -->
    <div class="ui modal" id="vettings">
      <i class="close icon"></i>
      <div class="ui center aligned header">Vettings</div>
      <div class="content">
        {% set flashes =
        { 'error': get_flashed_messages(category_filter=['form-error']),
        'warning': get_flashed_messages(category_filter=['form-check-email']),
        'info': get_flashed_messages(category_filter=['form-info']),
        'success': get_flashed_messages(category_filter=['form-success']) }
        %}
        {{ f.begin_form(add_vetting, flashes) }}
        <div class="ui two column stackable grid">
          <h3 class="eight wide column">Service Vettings</h3>
          <div class="eight wide column" style="text-align:right">
            {{f.render_form_field(add_vetting.volunteer_fully_vetted_checkbox) }}
          </div>
        </div>

        <div class="ui attached segment">
          <h3 class="ui top attached header">
            Notes
          </h3>
          <div class="ui fluid attached segment">
            <p>{{f.render_form_field(add_vetting.vetting_notes)}}</p>
          </div>
          {{ f.form_message(flashes['error'], header='Something went wrong.',
          class='error') }}
          {{ f.form_message(flashes['warning'], header='Check your
          email.', class='warning') }}
          {{ f.form_message(flashes['info'],
          header='Information', class='info') }}
          {{ f.form_message(flashes['success'],
          header='Success!', class='success') }}
          {{ f.render_form_field(add_vetting.submit) }}
        </div>
      </div>
      {{ f.end_form() }}
    </div>
  </div>

  <div class="ui tab" data-tab="local-resource">
    <div class="ui stackable centered grid container">
      <div class="four wide column">
        {{ dashboard_option('Add Local Resource', 'admin.invite_contractor', icon='add user icon') }}
        <h3>Search:</h3>
        <div class="ui search item">
          <div class="ui transparent icon input">
            <input id="search-people" type="text" placeholder="Enter name...">
            <i class="search icon"></i>
          </div>
        </div>
      </div>

      <div class="twelve wide column">
        <h3>Search Results</h3>
        <div class="ui segment search-results">
          {% for lr in local_resources %}
          <div class="ui fluid card" data-role={{"Local Resource"}}>
            {{local_resource_card(lr)}}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Availability Pop Up -->
    <div class="ui fullscreen modal" id="availability">
      <i class="close icon"></i>
      <div class="header">Add Availability</div>
      <div class="content">

        {% set flashes =
        { 'error': get_flashed_messages(category_filter=['form-error']),
        'warning': get_flashed_messages(category_filter=['form-check-email']),
        'info': get_flashed_messages(category_filter=['form-info']),
        'success': get_flashed_messages(category_filter=['form-success']) }
        %}

        {{ f.begin_form(add_availability, flashes) }}

        <div class="ui header">Monday:</div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available:</a>
          <span>{{ f.render_form_field(add_availability.availability_monday) }}</span>
        </div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available For Backup:</a>
          <span>{{ f.render_form_field(add_availability.backup_monday) }}</span>
        </div>

        <div class="ui header">Tuesday:</div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available:</a>
          <span>{{ f.render_form_field(add_availability.availability_tuesday) }}</span>
        </div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available For Backup:</a>
          <span>{{ f.render_form_field(add_availability.backup_tuesday) }}</span>
        </div>

        <div class="ui header">Wednesday:</div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available:</a>
          <span>{{ f.render_form_field(add_availability.availability_wednesday) }}</span>
        </div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available For Backup:</a>
          <span>{{ f.render_form_field(add_availability.backup_wednesday) }}</span>
        </div>

        <div class="ui header">Thursday:</div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available:</a>
          <span>{{ f.render_form_field(add_availability.availability_thursday) }}</span>
        </div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available For Backup:</a>
          <span>{{ f.render_form_field(add_availability.backup_thursday) }}</span>
        </div>

        <div class="ui header">Friday:</div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available:</a>
          <span>{{ f.render_form_field(add_availability.availability_friday) }}</span>
        </div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available For Backup:</a>
          <span>{{ f.render_form_field(add_availability.backup_friday) }}</span>
        </div>

        <div class="ui header">Saturday:</div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available:</a>
          <span>{{ f.render_form_field(add_availability.availability_saturday) }}</span>
        </div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available For Backup:</a>
          <span>{{ f.render_form_field(add_availability.backup_saturday) }}</span>
        </div>

        <div class="ui header">Sunday:</div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available:</a>
          <span>{{ f.render_form_field(add_availability.availability_sunday) }}</span>
        </div>
        <div class="ui segment">
          <a class="ui purple ribbon label">Available For Backup:</a>
          <span>{{ f.render_form_field(add_availability.backup_sunday) }}</span>
        </div>

        <div class="actions">
          {{ f.form_message(flashes['error'], header='Something went wrong.',
          class='error') }}
          {{ f.form_message(flashes['warning'], header='Check your
          email.', class='warning') }}
          {{ f.form_message(flashes['info'],
          header='Information', class='info') }}
          {{ f.form_message(flashes['success'],
          header='Success!', class='success') }}
          {{ f.render_form_field(add_availability.submit) }}
        </div>
        {{ f.end_form() }}
      </div>
    </div>

    <!-- Reviews Pop Up -->
    <div class="ui modal" id="reviews">
      <i class="close icon"></i>
      <div class="header">Reviews</div>

      {% set flashes = { 'error':
      get_flashed_messages(category_filter=['form-error']), 'warning':
      get_flashed_messages(category_filter=['form-check-email']), 'info':
      get_flashed_messages(category_filter=['form-info']), 'success':
      get_flashed_messages(category_filter=['form-success']) } %} {{
      f.begin_form(reviews, flashes) }}

      <div class="ui styled fluid accordion">
        <div class="active title">
          <i class="dropdown icon"></i>
          Add A Review
        </div>
        <div class="active content">
          <div class="two fields">
            <div class="field">
              {{ f.render_form_field(reviews.reviewer_name) }}
            </div>
            <div class="field">
              <label>Rating:</label>
              <div class="ui massive star rating" data-max-rating="5"></div>
            </div>
          </div>
          {{ f.render_form_field(reviews.notes) }}
        </div>
        <div class="title">
          <i class="dropdown icon"></i>
          Previous Reviews
        </div>
        <div class="content">
          <div class="transition hidden">
            <div class="ui form">{{ f.render_form_field(reviews.notes) }}</div>
          </div>
        </div>

        <div class="actions">
          {{ f.form_message(flashes['error'], header='Something went wrong.',
          class='error') }}
          {{ f.form_message(flashes['warning'], header='Check your
          email.', class='warning') }}
          {{ f.form_message(flashes['info'],
          header='Information', class='info') }}
          {{ f.form_message(flashes['success'],
          header='Success!', class='success') }}
          {{f.render_form_field(reviews.submit) }}
        </div>
        {{ f.end_form() }}

      </div>
    </div>

    <script language='javascript'>
      $(document).ready(function () {
        $('.ui.accordion').accordion();
        $('.ui.checkbox').checkbox();
      });

      $(document)
        .ready(function () {
          $('.menu .item').tab();

          // function filterPeople() {
          //   let peopleFilter = $('#role-field').val();
          //   $('.card').each(function () {
          //     $this = $(this);
          //     $this.show();

          //     // Filter by role
          //     let role = this.getAttribute('data-role');
          //     if (role != peopleFilter) {
          //       $this.hide();
          //     }
          //   });
          // }

          $('#search-people').keyup(function () {
            //   filterPeople();
            var searchText = $(this).val();
            if (searchText.length > 0) {
              $('.search-results .header:icontains(' + searchText + ')').closest('.card').addClass('positive');
              $('.card.positive .header').not(':icontains(' + searchText + ')').removeClass('positive');
              $('.search-results .header').not(':icontains(' + searchText + ')').closest('.card').addClass('hidden').hide();
              $('.card.hidden .header:icontains(' + searchText + ')').removeClass('hidden').show();
            } else {
              $('.card.positive').removeClass('positive');
              $('.card.hidden').removeClass('hidden').show();
            }
          });

        })

      $('i.handshake.outline.icon.right.floated').click(function () {
        $('#services').modal('show');
      });

      $('i.check.square.outline.icon.right.floated').click(function () {
        $('#vettings').modal('show');
      });

      $('#context1 .menu .item').tab({
        context: $('#context1'),
      });

      $('i.clock.outline.icon.right.floated').click(function () {
        $('#availability').modal('show');
      });

      $('i.comment.outline.icon.right.floated').click(function () {
        $('#reviews').modal('show');
      });

      $('.ui.accordion').accordion({ exclusive: false });

      $('.ui.rating').rating();

    </script>

    {% endblock %}